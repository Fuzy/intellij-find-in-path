buildscript {
    repositories {
        mavenCentral()
    }
}

plugins {
    id 'java'
    id "org.jetbrains.intellij" version "0.6.5"
}

group 'com.fuzy.idea'
version '1.0.0'

sourceCompatibility = 11

repositories {
    mavenCentral()
}

dependencies {
    testCompile group: 'junit', name: 'junit', version: '4.13'
    compile 'com.yworks:yguard:2.10.0'
}

apply plugin: 'org.jetbrains.intellij'

// See https://github.com/JetBrains/gradle-intellij-plugin/
intellij {
    version '2020.3'
}

/**
 * Simple function to load HTML files and remove the surrounding `<html>` tags. This is useful for maintaining changes-notes
 * and the description of plugins in separate HTML files which makes them much more readable.
 */
def htmlFixer = { filename ->
    if (!file(filename).exists()) {
        logger.error("File $filename not found.")
    } else {
        return file(filename).getText('UTF-8').replace("<html>", "").replace("</html>", "").trim()
    }
    return ""
}

def changeNotesHtml = htmlFixer("src/main/resources/META-INF/change-notes.html")
def pluginDescriptionHtml = htmlFixer("src/main/resources/META-INF/description.html")

patchPluginXml {
    changeNotes "${changeNotesHtml}"
    pluginDescription "${pluginDescriptionHtml}"
}

ext {
    mainClassName = "com.fuzy.find.action.FindInPathChooseConfigAction"
    basename = "find-in-path-profile-idea-plugin"
    version = "1.0.0"
    ideaICLib = '/home/fuzy/.gradle/caches/modules-2/files-2.1/com.jetbrains.intellij.idea/ideaIC/2020.2/4fe93bb81525f2fa7a6f0fd7ba41c3b9cce9e8b6/ideaIC-2020.2/lib'
}

// Proguard doesn't have support for Java11
task obfuscate {
    dependsOn jar
    group 'yGuard'
    description 'Obfuscates and shrinks the java archive.'

    doLast {
        ant.taskdef(
                name: 'yguard',
                classname: 'com.yworks.yguard.YGuardTask',
                classpath: sourceSets.main.runtimeClasspath.asPath
        )

        def archivePath = jar.archiveFile.get().asFile.path
        ant.yguard {
            inoutpair(in: archivePath, out: archivePath.replace(".jar", "-obf.jar"))

            externalclasses {
                pathelement(location: "${ideaICLib}/platform-api.jar")
                pathelement(location: "${ideaICLib}/platform-impl.jar")
                pathelement(location: "${ideaICLib}/util.jar")
                pathelement(location: "${ideaICLib}/extensions.jar")
                pathelement(location: "${ideaICLib}/platform-core-ui.jar")
            }

            shrink(logfile: "${buildDir}/yshrink.log.xml") {
                keep {
                    'class'(classes: 'public', methods: 'private')
                }
            }

            rename(mainclass: mainClassName, logfile: "${buildDir}/yguard.log.xml") {
                property(name: "error-checking", value: "pedantic")

                keep {
                    'class'(name: 'com.fuzy.find.persistence.ConfigurationManager')
                    'class'(name: 'com.fuzy.find.listener.FindWindowManagerListener')
                    'class'(name: 'com.fuzy.find.persistence.FindOption', methods: 'private', fields: 'private')
                    'class'(name: 'com.fuzy.find.persistence.FindOptions', methods: 'private', fields: 'private')
                    method(name: "com.fuzy.find.persistence.FindOptions getState()", 'class': 'com.fuzy.find.persistence.ConfigurationManager')
                    method(name: "void loadState(com.fuzy.find.persistence.FindOptions)", 'class': 'com.fuzy.find.persistence.ConfigurationManager')
                }
            }

        }
    }

    runPluginVerifier {
        ideVersions('2020.3')
    }

}
